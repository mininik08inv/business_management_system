{% extends 'base.html' %}

{% block title %}{{ task.title }}{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header">
        <h2>{{ task.title }}</h2>
    </div>
    <div class="card-body">
        <p>{{ task.description }}</p>

        <div class="row mb-3">
            <div class="col-md-4">
                <strong>Статус:</strong>
                <span class="badge bg-{% if task.status == 'completed' %}success{% else %}warning{% endif %}">
                    {{ task.get_status_display }}
                </span>
            </div>
            <div class="col-md-4">
                <strong>Приоритет:</strong> {{ task.get_priority_display }}
            </div>
            <div class="col-md-4">
                <strong>Срок:</strong> {{ task.deadline|date:"d.m.Y H:i" }}
            </div>
        </div>

        <div class="row">
            <div class="col-md-5">
                <strong>Создал:</strong> {{ task.created_by }}
            </div>
            <div class="col-md-5">
                <strong>Команда:</strong> {{ task.responsible_team|default:"Не назначен" }}
            </div>
            <div class="col-md-5">
                <strong>Исполнитель:</strong> {{ task.assigned_to|default:"Не назначен" }}
            </div>
        </div>

        <form method="post" action="{% url 'tasks:update_status' task.pk %}" class="mt-4">
            {% csrf_token %}
            <div class="input-group">
                <select name="status" class="form-select">
                    {% for status in task.STATUS_CHOICES %}
                    <option value="{{ status.0 }}" {% if task.status is status.0 %}selected{% endif %}>
                        {{ status.1 }}
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary">Обновить статус</button>
            </div>
            {% if rating %}
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Оценка руководителя</h5>
                    <p class="card-text">
                        <strong>Оценка:</strong> {{ rating.get_score_display }}<br>
                        {% if rating.feedback %}
                        <strong>Комментарий:</strong> {{ rating.feedback }}
                        {% endif %}
                    </p>
                    <small class="text-muted">
                        Оценено {{ rating.rated_by }} ({{ rating.rated_at|date }})
                    </small>
                </div>
            </div>
            {% elif can_rate_task %}
            <a href="{% url 'tasks:rate_task' pk=task.pk %}" class="btn btn-success">
                Поставить оценку
            </a>
            {% endif %}
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>Комментарии</h3>
    </div>
    <div class="card-body">
        {% for comment in task.comments.all %}
        <div class="mb-3 border-bottom pb-2">
            <div class="d-flex justify-content-between">
                <strong>{{ comment.author }}</strong>
                <small class="text-muted">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
            </div>
            <p class="mb-0">{{ comment.text }}</p>
        </div>
        {% empty %}
        <div class="text-center py-2 text-muted">
            Нет комментариев
        </div>
        {% endfor %}

        <form method="post" action="{% url 'tasks:add_comment' task.pk %}" class="mt-3">
            {% csrf_token %}
            <div class="mb-3">
                <textarea name="text" class="form-control" rows="3" placeholder="Ваш комментарий"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Добавить комментарий</button>
        </form>
    </div>
</div>
{% endblock %}